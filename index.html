<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RootPay Integration</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>RootPay Integration</h1>
    
    <!-- Setup Form -->
    <div id="setup-form">
      <div class="form-group">
        <label for="token">RootPay Token:</label>
        <input type="text" id="token" placeholder="Enter your RootPay session token">
      </div>
      
      <div class="form-group">
        <label for="payee-id">Payee ID:</label>
        <input type="text" id="payee-id" placeholder="Enter payee ID">
      </div>
      
      <button id="initialize-btn">Initialize Payment Form</button>
    </div>
    
    <!-- Main UI (initially hidden) -->
    <div id="main-ui" class="hidden">
      <h2>Enter Payment Information</h2>
      
      <!-- Payment Method Selector -->
      <div class="form-group">
        <label>Payment Method:</label>
        <label style="margin-right: 20px;"><input type="radio" name="payment-method-type" value="card" checked> Card</label>
        <label><input type="radio" name="payment-method-type" value="bank"> Bank</label>
      </div>
      
      <!-- Card Fields -->
      <div id="card-fields">
        <div class="form-group">
          <label for="card-number-container">Card Number:</label>
          <div id="card-number-container" class="field-container"></div>
        </div>
        <div class="form-group">
          <label for="card-expiry-container">Expiration Date (MM/YY):</label>
          <div id="card-expiry-container" class="field-container"></div>
        </div>
      </div>
      
      <!-- Bank Fields (initially hidden) -->
      <div id="bank-fields" style="display:none;">
        <div class="form-group">
          <label for="account-number-container">Account Number:</label>
          <div id="account-number-container" class="field-container"></div>
        </div>
        <div class="form-group">
          <label for="routing-number-container">Routing Number:</label>
          <div id="routing-number-container" class="field-container"></div>
        </div>
      </div>
      
      <button id="payment-button" disabled>Submit Payment Method</button>
      
      <div id="payment-status" class="status"></div>
      <div id="response-details" class="response-details"></div>
    </div>
    
    <div class="demo-notice">
      <h3>RootPay Demo Instructions</h3>
      <p><strong>Prerequisites:</strong></p>
      <ol>
        <li>You must have a RootPay account to use this demo</li>
        <li>You need an API Key from your RootPay account</li>
        <li>You need a specific payee ID from your RootPay account</li>
        <li>Generate a session token using the token endpoint (see documentation at <a href="https://docs.root.credit" target="_blank">docs.root.credit</a>)</li>
      </ol>
      <p><strong>Test Values:</strong></p>
      <ul>
        <li><strong>Card:</strong> 4111 1111 1111 1111 with any future expiry date</li>
        <li><strong>Account Number:</strong> 1234567890</li>
        <li><strong>Routing Number:</strong> 111000025</li>
      </ul>
    </div>
  </div>
  
  <!-- Include the RootPay SDK -->
  <script src="https://cdn.jsdelivr.net/gh/root-credit/root-pay-js-sdk@latest/rootpay.min.js"></script>
  
  <script>
    // ===================================================
    // DOM ELEMENTS & STATE
    // ===================================================
    
    // Elements
    const elements = {
      setupForm: document.getElementById('setup-form'),
      mainUi: document.getElementById('main-ui'),
      tokenInput: document.getElementById('token'),
      payeeIdInput: document.getElementById('payee-id'),
      initializeBtn: document.getElementById('initialize-btn'),
      paymentButton: document.getElementById('payment-button'),
      paymentStatus: document.getElementById('payment-status'),
      responseDetails: document.getElementById('response-details'),
      cardFields: document.getElementById('card-fields'),
      bankFields: document.getElementById('bank-fields')
    };
    
    // State
    const state = {
      rootpay: null,
      fields: {
        cardNumber: null,
        cardExpiry: null,
        accountNumber: null,
        routingNumber: null
      },
      paymentType: 'card',
      validation: {
        cardNumber: false,
        cardExpiry: false,
        accountNumber: false,
        routingNumber: false
      }
    };
    
    // ===================================================
    // DEFAULT FIELD STYLES
    // ===================================================
    
    const defaultStyles = {
      cardNumber: {
        fontSize: '18px',
        fontWeight: '500',
        color: '#333',
        letterSpacing: '1px'
      },
      cardExpiry: {
        fontSize: '18px',
        fontWeight: '500',
        color: '#333'
      }
    };
    
    // ===================================================
    // UI MANAGEMENT
    // ===================================================
    
    /**
     * Update submit button state based on validation
     */
    function updateSubmitButtonState() {
      const isValid = state.paymentType === 'card'
        ? (state.validation.cardNumber && state.validation.cardExpiry)
        : (state.validation.accountNumber && state.validation.routingNumber);
      
      elements.paymentButton.disabled = !isValid;
      elements.paymentButton.style.opacity = isValid ? '1' : '0.5';
      elements.paymentButton.style.cursor = isValid ? 'pointer' : 'not-allowed';
      
      console.log('Form validation:', isValid ? 'Valid' : 'Invalid');
    }
    
    /**
     * Show status message
     */
    function showStatus(message, type) {
      elements.paymentStatus.textContent = message;
      elements.paymentStatus.className = `status ${type}`;
      elements.paymentStatus.style.display = 'block';
      
      // Auto-hide success messages
      if (type === 'success') {
        setTimeout(() => {
          if (elements.paymentStatus.textContent === message) {
            elements.paymentStatus.style.display = 'none';
          }
        }, 5000);
      }
    }
    
    /**
     * Clear status message
     */
    function clearStatus() {
      elements.paymentStatus.style.display = 'none';
      elements.paymentStatus.textContent = '';
      elements.paymentStatus.className = 'status';
    }
    
    /**
     * Format error details for display
     */
    function formatErrorDetails(response) {
      if (typeof response !== 'object' || response === null) {
        return JSON.stringify(response, null, 2);
      }
      
      let result = '';
      
      if (response.status) {
        result += `Status Code: ${response.status}\n\n`;
      }
      
      if (response.error) {
        result += `Error: ${response.error}\n\n`;
      }
      
      if (response.details) {
        result += 'Details:\n' + JSON.stringify(response.details, null, 2);
      } else {
        result += 'Full Response:\n' + JSON.stringify(response, null, 2);
      }
      
      return result;
    }
    
    /**
     * Display API response details
     */
    function displayResponseDetails(response, isSuccess) {
      // Format and show the response
      if (isSuccess) {
        elements.responseDetails.textContent = JSON.stringify(response, null, 2);
        elements.responseDetails.classList.remove('error');
        elements.responseDetails.classList.add('success');
      } else {
        elements.responseDetails.textContent = formatErrorDetails(response);
        elements.responseDetails.classList.remove('success');
        elements.responseDetails.classList.add('error');
      }
      
      elements.responseDetails.style.display = 'block';
    }
    
    // ===================================================
    // FIELD CREATION
    // ===================================================
    
    /**
     * Create card payment fields
     */
    function createCardFields() {
      if (!state.fields.cardNumber) {
        state.fields.cardNumber = state.rootpay.field('#card-number-container', {
          type: 'card-number',
          name: 'card-number',
          style: defaultStyles.cardNumber,
          onValidChange: function(isValid) {
            state.validation.cardNumber = isValid;
            updateSubmitButtonState();
          }
        });
      }
      
      if (!state.fields.cardExpiry) {
        state.fields.cardExpiry = state.rootpay.field('#card-expiry-container', {
          type: 'card-expiry',
          name: 'card-expiry',
          style: defaultStyles.cardExpiry,
          onValidChange: function(isValid) {
            state.validation.cardExpiry = isValid;
            updateSubmitButtonState();
          }
        });
      }
    }
    
    /**
     * Create bank payment fields
     */
    function createBankFields() {
      if (!state.fields.accountNumber) {
        state.fields.accountNumber = state.rootpay.field('#account-number-container', {
          type: 'account-number',
          name: 'account-number',
          style: defaultStyles.cardNumber,
          onValidChange: function(isValid) {
            state.validation.accountNumber = isValid;
            updateSubmitButtonState();
          }
        });
      }
      
      if (!state.fields.routingNumber) {
        state.fields.routingNumber = state.rootpay.field('#routing-number-container', {
          type: 'routing-number',
          name: 'routing-number',
          style: defaultStyles.cardExpiry,
          onValidChange: function(isValid) {
            state.validation.routingNumber = isValid;
            updateSubmitButtonState();
          }
        });
      }
    }
    
    // ===================================================
    // EVENT HANDLERS
    // ===================================================
    
    /**
     * Initialize RootPay
     */
    function initializeRootPay() {
      const token = elements.tokenInput.value.trim();
      const payeeId = elements.payeeIdInput.value.trim();
      
      if (!token) {
        showStatus('Please enter a valid token', 'error');
        return;
      }
      
      if (!payeeId) {
        showStatus('Please enter a valid payee ID', 'error');
        return;
      }
      
      try {
        // Initialize RootPay instance
        state.rootpay = RootPay.init({
          token: token,
          payee_id: payeeId,
          debug: true,
          onSuccess: function(response) {
            showStatus('Payment method added successfully!', 'success');
            displayResponseDetails(response, true);
          },
          onError: function(errorMessage, errorDetails) {
            showStatus('Error: ' + errorMessage, 'error');
            displayResponseDetails(errorDetails, false);
          }
        });
        
        // Create initial card fields
        createCardFields();
        
        // Show main UI, hide setup form
        elements.setupForm.classList.add('hidden');
        elements.mainUi.classList.remove('hidden');
        
        // Ensure button is initially disabled
        elements.paymentButton.disabled = true;
        elements.paymentButton.style.opacity = '0.5';
        elements.paymentButton.style.cursor = 'not-allowed';
        
        console.log('RootPay initialized successfully');
      } catch (error) {
        showStatus('Error initializing RootPay: ' + error.message, 'error');
        console.error('Initialization error:', error);
      }
    }
    
    /**
     * Handle payment method switch
     */
    function handlePaymentMethodSwitch(e) {
      state.paymentType = e.target.value;
      
      if (state.paymentType === 'card') {
        elements.cardFields.style.display = '';
        elements.bankFields.style.display = 'none';
        createCardFields();
      } else {
        elements.cardFields.style.display = 'none';
        elements.bankFields.style.display = '';
        createBankFields();
      }
      
      updateSubmitButtonState();
    }
    
    /**
     * Submit payment method
     */
    function submitPaymentMethod() {
      if (!state.rootpay) {
        showStatus('RootPay not initialized', 'error');
        return;
      }
      
      if (elements.paymentButton.disabled) {
        showStatus('Please fill in all required fields correctly', 'error');
        return;
      }
      
      clearStatus();
      elements.responseDetails.style.display = 'none';
      
      showStatus('Processing payment method...', 'info');
      
      state.rootpay.submitPaymentMethod(function(status, response) {
        console.log('Submission status:', status);
        
        if (status === 201) {
          showStatus('Payment method added successfully!', 'success');
          displayResponseDetails(response, true);
        } else {
          const errorMessage = response.error || 'Unknown error';
          const statusCode = response.status || status;
          showStatus(`Error ${statusCode}: ${errorMessage}`, 'error');
          displayResponseDetails(response, false);
        }
      }, state.paymentType);
    }
    
    // ===================================================
    // EVENT LISTENERS
    // ===================================================
    
    // Initialize everything when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure button is disabled initially
      elements.paymentButton.disabled = true;
      elements.paymentButton.style.opacity = '0.5';
      elements.paymentButton.style.cursor = 'not-allowed';
      
      // Set up event listeners
      elements.initializeBtn.addEventListener('click', initializeRootPay);
      elements.paymentButton.addEventListener('click', submitPaymentMethod);
      
      // Payment method selection
      document.querySelectorAll('input[name="payment-method-type"]').forEach(radio => {
        radio.addEventListener('change', handlePaymentMethodSwitch);
      });
    });
  </script>
</body>
</html>